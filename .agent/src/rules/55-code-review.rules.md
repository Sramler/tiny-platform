# 55 代码审查规范

## 适用范围

- 适用于：Pull Request、代码审查、代码评审相关流程
- 不适用于：紧急安全修复（但应事后补审）

## 总体策略

1. **质量优先**：代码审查是保证代码质量的重要环节，不应流于形式。
2. **学习交流**：代码审查是团队学习和知识分享的机会。
3. **及时反馈**：审查意见应及时给出，避免阻塞开发进度。

---

## 禁止（Must Not）

### 1) 审查态度

- ❌ 审查时使用攻击性语言或人身攻击。
- ❌ 审查时只提问题不提供建议或解决方案。
- ❌ 审查时过度关注代码风格（应使用工具自动检查）。

### 2) 审查流程

- ❌ 未经审查直接合并代码（紧急修复除外）。
- ❌ 审查者与提交者同一人（应至少一人审查）。

### 3) 审查内容

- ❌ 审查时忽略安全、性能、多租户隔离等关键问题。
- ❌ 审查时只关注功能实现，忽略代码质量和可维护性。

---

## 必须（Must）

### 1) 审查检查清单

- ✅ 功能正确性：代码实现是否符合需求，逻辑是否正确。
- ✅ 安全性：是否存在安全漏洞（SQL 注入、XSS、敏感信息泄漏等）。
- ✅ 多租户隔离：业务查询是否包含 `tenant_id` 过滤。
- ✅ 异常处理：异常处理是否合理，是否记录日志。
- ✅ 测试覆盖：关键逻辑是否有测试覆盖。

### 2) 审查反馈

- ✅ 审查意见：审查意见应清晰、具体、可操作。
- ✅ 优先级标记：审查意见应标记优先级（必须修改、建议修改、可选）。
- ✅ 及时响应：审查者应在 24 小时内给出审查意见。

### 3) 审查流程

- ✅ PR 描述：PR 必须包含清晰的描述（做了什么、为什么、怎么验证）。
- ✅ 审查通过：至少一人审查通过后才能合并。
- ✅ 审查记录：审查意见和修改记录应保留在 PR 中。

---

## 应该（Should）

### 1) 审查重点

- ⚠️ 代码设计：代码设计是否合理，是否符合设计原则。
- ⚠️ 性能影响：代码是否对性能有负面影响。
- ⚠️ 可维护性：代码是否易于理解和维护。
- ⚠️ 代码复用：是否存在重复代码，是否可以复用。

### 2) 审查工具

- ⚠️ 自动化检查：使用 CI 自动检查代码格式、静态分析、测试等。
- ⚠️ 代码对比：使用工具对比代码变更，便于审查。

### 3) 审查沟通

- ⚠️ 友好沟通：审查意见应友好、建设性，避免引起冲突。
- ⚠️ 讨论交流：复杂问题应通过讨论达成共识。

---

## 可以（May）

- 💡 代码审查模板：使用代码审查模板，确保审查全面。
- 💡 审查奖励：对优秀审查者给予认可和奖励。

---

## 例外与裁决

### 紧急修复

- 紧急安全修复：可先合并后审查，但必须事后补审并记录。

### 小改动

- 小改动（如文档、注释）：可简化审查流程，但仍需至少一人确认。

### 冲突裁决

- 平台特定规则（90+）优先于本规范。
- 审查意见与业务需求冲突时，应通过讨论达成共识。

---

## 示例

### ✅ 正例：PR 描述

```markdown
## 变更内容
- 添加用户头像上传功能
- 支持图片格式：jpg, png, webp
- 图片大小限制：5MB

## 变更原因
用户需要自定义头像，提升用户体验

## 验证方式
- 单元测试：UserControllerTest.testUploadAvatar
- 集成测试：手动上传图片验证
- 性能测试：并发上传 100 张图片

## 相关 Issue
Closes #123
```

### ✅ 正例：审查意见（清晰、具体、可操作）

```markdown
## 必须修改（Must Fix）

1. **安全问题**：SQL 注入风险
   - 位置：`UserService.java:45`
   - 问题：使用字符串拼接 SQL
   - 建议：使用参数化查询 `#{}`
   - 示例：
     ```java
     // 修改前
     String sql = "SELECT * FROM user WHERE id = " + id;
     
     // 修改后
     @Query("SELECT u FROM User u WHERE u.id = :id")
     User findById(@Param("id") Long id);
     ```

2. **多租户隔离**：缺少 tenant_id 过滤
   - 位置：`UserService.java:78`
   - 问题：查询未包含 tenant_id 过滤
   - 建议：添加 tenant_id 过滤条件
   - 示例：
     ```java
     Long tenantId = TenantContext.getCurrentTenantId();
     return userRepository.findByTenantIdAndId(tenantId, id);
     ```

## 建议修改（Should Fix）

1. **代码复用**：存在重复代码
   - 位置：`UserService.java:120` 和 `UserService.java:145`
   - 建议：提取公共方法
   
2. **异常处理**：缺少异常日志
   - 位置：`UserService.java:200`
   - 建议：添加异常日志记录

## 可选改进（May Improve）

1. **性能优化**：可以考虑使用缓存
   - 位置：`UserService.java:50`
   - 建议：对频繁查询的用户信息使用缓存
```

### ❌ 反例：审查意见不清晰

```markdown
## 审查意见

1. 代码有问题 ❌ 不清晰，不知道具体问题
2. 需要优化 ❌ 不具体，不知道如何优化
3. 不符合规范 ❌ 不明确，不知道哪里不符合
```

### ✅ 正例：审查检查清单

```markdown
## 代码审查检查清单

### 功能正确性
- [ ] 代码实现是否符合需求
- [ ] 逻辑是否正确
- [ ] 边界条件是否处理

### 安全性
- [ ] 是否存在 SQL 注入风险
- [ ] 是否存在 XSS 风险
- [ ] 敏感信息是否脱敏
- [ ] 权限验证是否充分

### 多租户隔离
- [ ] 业务查询是否包含 tenant_id 过滤
- [ ] 唯一性约束是否包含 tenant_id

### 异常处理
- [ ] 异常处理是否合理
- [ ] 是否记录异常日志
- [ ] 异常信息是否脱敏

### 测试覆盖
- [ ] 关键逻辑是否有单元测试
- [ ] 是否有集成测试
- [ ] 测试是否通过

### 代码质量
- [ ] 代码是否易于理解
- [ ] 是否存在重复代码
- [ ] 命名是否清晰
- [ ] 注释是否充分

### 性能影响
- [ ] 是否对性能有负面影响
- [ ] 是否有 N+1 查询问题
- [ ] 是否可以使用缓存
```

### ✅ 正例：友好沟通

```markdown
## 审查意见

感谢你的贡献！整体实现很好，有几个小建议：

1. **安全性**：这里使用参数化查询会更安全
   - 建议：使用 `@Query` 注解替代字符串拼接
   - 参考：可以参考 `UserRepository.findByUsername` 的实现

2. **多租户隔离**：这里需要添加 tenant_id 过滤
   - 建议：使用 `TenantContext.getCurrentTenantId()` 获取租户 ID
   - 参考：可以参考其他 Service 的实现方式

3. **代码复用**：这里和另一个方法有重复逻辑
   - 建议：提取公共方法，减少重复代码
   - 参考：可以看看 `CommonUtils.validateUser` 的实现

如果有什么问题，欢迎讨论！
```
